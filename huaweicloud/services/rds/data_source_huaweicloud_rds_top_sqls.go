// Generated by PMS #994
package rds

import (
	"context"
	"strings"

	"github.com/hashicorp/go-multierror"
	"github.com/hashicorp/go-uuid"
	"github.com/hashicorp/terraform-plugin-sdk/v2/diag"
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/schema"
	"github.com/tidwall/gjson"

	"github.com/huaweicloud/terraform-provider-huaweicloud/huaweicloud/config"
	"github.com/huaweicloud/terraform-provider-huaweicloud/huaweicloud/helper/httphelper"
	"github.com/huaweicloud/terraform-provider-huaweicloud/huaweicloud/helper/schemas"
	"github.com/huaweicloud/terraform-provider-huaweicloud/huaweicloud/utils"
)

func DataSourceRdsTopSqls() *schema.Resource {
	return &schema.Resource{
		ReadContext: dataSourceRdsTopSqlsRead,

		Schema: map[string]*schema.Schema{
			"region": {
				Type:        schema.TypeString,
				Optional:    true,
				Computed:    true,
				Description: `Specifies the region in which to query the resource. If omitted, the provider-level region will be used.`,
			},
			"instance_id": {
				Type:        schema.TypeString,
				Required:    true,
				Description: `Specifies the ID of the RDS instance.`,
			},
			"sort_key": {
				Type:        schema.TypeString,
				Optional:    true,
				Description: `Specifies the sort key.`,
			},
			"limit": {
				Type:        schema.TypeInt,
				Optional:    true,
				Description: `Specifies the limit of the top SQL. The max value is **15**.`,
			},
			"statement": {
				Type:        schema.TypeString,
				Optional:    true,
				Description: `Specifies the statement.`,
			},
			"sort_dir": {
				Type:        schema.TypeString,
				Optional:    true,
				Description: `Specifies the sort direction.`,
			},
			"avg_cpu_time_top_values": {
				Type:        schema.TypeList,
				Computed:    true,
				Description: `Indicates the top SQL list of average CPU time.`,
				Elem: &schema.Resource{
					Schema: map[string]*schema.Schema{
						"id": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the ID.`,
						},
						"data_type": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the data type.`,
						},
						"value": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the time consume, unit is **ms**.`,
						},
					},
				},
			},
			"total_cpu_time_top_values": {
				Type:        schema.TypeList,
				Computed:    true,
				Description: `Indicates the top SQL list of total CPU time.`,
				Elem: &schema.Resource{
					Schema: map[string]*schema.Schema{
						"id": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the ID.`,
						},
						"data_type": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the data type.`,
						},
						"value": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the time consume, unit is **ms**.`,
						},
					},
				},
			},
			"total_logical_reads_top_values": {
				Type:        schema.TypeList,
				Computed:    true,
				Description: `Indicates the top SQL list of total logical reads.`,
				Elem: &schema.Resource{
					Schema: map[string]*schema.Schema{
						"id": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the ID.`,
						},
						"data_type": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the data type.`,
						},
						"value": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the logical read consumption.`,
						},
					},
				},
			},
			"avg_duration_time_top_values": {
				Type:        schema.TypeList,
				Computed:    true,
				Description: `Indicates the top SQL list of total logical reads.`,
				Elem: &schema.Resource{
					Schema: map[string]*schema.Schema{
						"id": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the ID.`,
						},
						"data_type": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the data type.`,
						},
						"value": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the time consume, unit is **ms**.`,
						},
					},
				},
			},
			"avg_rows_top_values": {
				Type:        schema.TypeList,
				Computed:    true,
				Description: `Indicates the top SQL list of average rows.`,
				Elem: &schema.Resource{
					Schema: map[string]*schema.Schema{
						"id": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the ID.`,
						},
						"data_type": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the data type.`,
						},
						"value": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the row number.`,
						},
					},
				},
			},
			"avg_logical_top_values": {
				Type:        schema.TypeList,
				Computed:    true,
				Description: `Indicates the top SQL list of average logical.`,
				Elem: &schema.Resource{
					Schema: map[string]*schema.Schema{
						"id": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the ID.`,
						},
						"data_type": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the data type.`,
						},
						"value": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the logical read consumption.`,
						},
					},
				},
			},
			"total_duration_time_top_values": {
				Type:        schema.TypeList,
				Computed:    true,
				Description: `Indicates the top SQL list of total duration time.`,
				Elem: &schema.Resource{
					Schema: map[string]*schema.Schema{
						"id": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the ID.`,
						},
						"data_type": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the data type.`,
						},
						"value": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the time consume, unit is **ms**.`,
						},
					},
				},
			},
			"total_rows_top_values": {
				Type:        schema.TypeList,
				Computed:    true,
				Description: `Indicates the top SQL list of total rows.`,
				Elem: &schema.Resource{
					Schema: map[string]*schema.Schema{
						"id": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the ID.`,
						},
						"data_type": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the data type.`,
						},
						"value": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the row number.`,
						},
					},
				},
			},
			"list": {
				Type:        schema.TypeList,
				Computed:    true,
				Description: `Indicates the top SQL list.`,
				Elem: &schema.Resource{
					Schema: map[string]*schema.Schema{
						"id": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the ID.`,
						},
						"avg_logical_reads": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the average logical reads.`,
						},
						"query": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the SQL full text.`,
						},
						"execution_count": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the execution count.`,
						},
						"avg_duration_time_percent": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the average duration time percent.`,
						},
						"avg_rows": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the average row number.`,
						},
						"avg_physical_reads": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the average physical reads.`,
						},
						"total_duration_time_percent": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the total duration time percent.`,
						},
						"total_rows_percent": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the total rows percent.`,
						},
						"total_logical_reads_percent": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the total logical reads percent.`,
						},
						"avg_logical_reads_percent": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the average logical reads percent.`,
						},
						"avg_logical_write_percent": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the average logical write percent.`,
						},
						"last_execution_time": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the last execution time.`,
						},
						"total_cpu_time": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the total cpu time, unit is **ms**.`,
						},
						"avg_rows_percent": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the average rows percent.`,
						},
						"total_logical_write": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the total logical write.`,
						},
						"total_physical_reads": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the total physical reads.`,
						},
						"avg_cpu_time": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the average cpu time, unit is **ms**.`,
						},
						"total_physical_reads_percent": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the total physical reads percent.`,
						},
						"avg_cpu_time_percent": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the average cpu time percent.`,
						},
						"statement": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the statement of the SQL.`,
						},
						"avg_duration_time": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the average duration time.`,
						},
						"total_rows": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the total row number.`,
						},
						"avg_physical_reads_percent": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the average physical reads percent.`,
						},
						"total_duration_time": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the total duration time.`,
						},
						"avg_logical_write": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the average logical write.`,
						},
						"total_logical_write_percent": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the total logical write percent.`,
						},
						"db_name": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the database name.`,
						},
						"execution_count_percent": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the execution count percent.`,
						},
						"total_cpu_time_percent": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the total cpu time percent.`,
						},
						"total_logical_reads": {
							Type:        schema.TypeString,
							Computed:    true,
							Description: `Indicates the total logical reads.`,
						},
					},
				},
			},
		},
	}
}

type TopSqlsDSWrapper struct {
	*schemas.ResourceDataWrapper
	Config *config.Config
}

func newTopSqlsDSWrapper(d *schema.ResourceData, meta interface{}) *TopSqlsDSWrapper {
	return &TopSqlsDSWrapper{
		ResourceDataWrapper: schemas.NewSchemaWrapper(d),
		Config:              meta.(*config.Config),
	}
}

func dataSourceRdsTopSqlsRead(_ context.Context, d *schema.ResourceData, meta interface{}) diag.Diagnostics {
	wrapper := newTopSqlsDSWrapper(d, meta)
	listTopSqlsRst, err := wrapper.ListTopSqls()
	if err != nil {
		return diag.FromErr(err)
	}

	id, err := uuid.GenerateUUID()
	if err != nil {
		return diag.FromErr(err)
	}
	d.SetId(id)

	err = wrapper.listTopSqlsToSchema(listTopSqlsRst)
	if err != nil {
		return diag.FromErr(err)
	}

	return nil
}

// @API RDS GET /v3/{project_id}/instances/{instance_id}/top-sqls
func (w *TopSqlsDSWrapper) ListTopSqls() (*gjson.Result, error) {
	client, err := w.NewClient(w.Config, "rds")
	if err != nil {
		return nil, err
	}

	uri := "/v3/{project_id}/instances/{instance_id}/top-sqls"
	uri = strings.ReplaceAll(uri, "{instance_id}", w.Get("instance_id").(string))
	params := map[string]any{
		"sort_key":  w.Get("sort_key"),
		"limit":     w.Get("limit"),
		"statement": w.Get("statement"),
		"sort_dir":  w.Get("sort_dir"),
	}
	params = utils.RemoveNil(params)
	return httphelper.New(client).
		Method("GET").
		URI(uri).
		Query(params).
		Request().
		Result()
}

func (w *TopSqlsDSWrapper) listTopSqlsToSchema(body *gjson.Result) error {
	d := w.ResourceData
	mErr := multierror.Append(nil,
		d.Set("region", w.Config.GetRegion(w.ResourceData)),
		d.Set("avg_cpu_time_top_values", schemas.SliceToList(body.Get("avg_cpu_time_top_values"),
			func(acttv gjson.Result) any {
				return map[string]any{
					"id":        acttv.Get("id").Value(),
					"data_type": acttv.Get("data_type").Value(),
					"value":     acttv.Get("value").Value(),
				}
			},
		)),
		d.Set("total_cpu_time_top_values", schemas.SliceToList(body.Get("total_cpu_time_top_values"),
			func(tcttv gjson.Result) any {
				return map[string]any{
					"id":        tcttv.Get("id").Value(),
					"data_type": tcttv.Get("data_type").Value(),
					"value":     tcttv.Get("value").Value(),
				}
			},
		)),
		d.Set("total_logical_reads_top_values", schemas.SliceToList(body.Get("total_logical_reads_top_values"),
			func(tlrtv gjson.Result) any {
				return map[string]any{
					"id":        tlrtv.Get("id").Value(),
					"data_type": tlrtv.Get("data_type").Value(),
					"value":     tlrtv.Get("value").Value(),
				}
			},
		)),
		d.Set("avg_duration_time_top_values", schemas.SliceToList(body.Get("avg_duration_time_top_values"),
			func(adttv gjson.Result) any {
				return map[string]any{
					"id":        adttv.Get("id").Value(),
					"data_type": adttv.Get("data_type").Value(),
					"value":     adttv.Get("value").Value(),
				}
			},
		)),
		d.Set("avg_rows_top_values", schemas.SliceToList(body.Get("avg_rows_top_values"),
			func(avgRowTopValues gjson.Result) any {
				return map[string]any{
					"id":        avgRowTopValues.Get("id").Value(),
					"data_type": avgRowTopValues.Get("data_type").Value(),
					"value":     avgRowTopValues.Get("value").Value(),
				}
			},
		)),
		d.Set("avg_logical_top_values", schemas.SliceToList(body.Get("avg_logical_top_values"),
			func(avgLogTopValues gjson.Result) any {
				return map[string]any{
					"id":        avgLogTopValues.Get("id").Value(),
					"data_type": avgLogTopValues.Get("data_type").Value(),
					"value":     avgLogTopValues.Get("value").Value(),
				}
			},
		)),
		d.Set("total_duration_time_top_values", schemas.SliceToList(body.Get("total_duration_time_top_values"),
			func(tdttv gjson.Result) any {
				return map[string]any{
					"id":        tdttv.Get("id").Value(),
					"data_type": tdttv.Get("data_type").Value(),
					"value":     tdttv.Get("value").Value(),
				}
			},
		)),
		d.Set("total_rows_top_values", schemas.SliceToList(body.Get("total_rows_top_values"),
			func(totRowTopValues gjson.Result) any {
				return map[string]any{
					"id":        totRowTopValues.Get("id").Value(),
					"data_type": totRowTopValues.Get("data_type").Value(),
					"value":     totRowTopValues.Get("value").Value(),
				}
			},
		)),
		d.Set("list", schemas.SliceToList(body.Get("list"),
			func(list gjson.Result) any {
				return map[string]any{
					"id":                           list.Get("id").Value(),
					"avg_logical_reads":            list.Get("avg_logical_reads").Value(),
					"query":                        list.Get("query").Value(),
					"execution_count":              list.Get("execution_count").Value(),
					"avg_duration_time_percent":    list.Get("avg_duration_time_percent").Value(),
					"avg_rows":                     list.Get("avg_rows").Value(),
					"avg_physical_reads":           list.Get("avg_physical_reads").Value(),
					"total_duration_time_percent":  list.Get("total_duration_time_percent").Value(),
					"total_rows_percent":           list.Get("total_rows_percent").Value(),
					"total_logical_reads_percent":  list.Get("total_logical_reads_percent").Value(),
					"avg_logical_reads_percent":    list.Get("avg_logical_reads_percent").Value(),
					"avg_logical_write_percent":    list.Get("avg_logical_write_percent").Value(),
					"last_execution_time":          list.Get("last_execution_time").Value(),
					"total_cpu_time":               list.Get("total_cpu_time").Value(),
					"avg_rows_percent":             list.Get("avg_rows_percent").Value(),
					"total_logical_write":          list.Get("total_logical_write").Value(),
					"total_physical_reads":         list.Get("total_physical_reads").Value(),
					"avg_cpu_time":                 list.Get("avg_cpu_time").Value(),
					"total_physical_reads_percent": list.Get("total_physical_reads_percent").Value(),
					"avg_cpu_time_percent":         list.Get("avg_cpu_time_percent").Value(),
					"statement":                    list.Get("statement").Value(),
					"avg_duration_time":            list.Get("avg_duration_time").Value(),
					"total_rows":                   list.Get("total_rows").Value(),
					"avg_physical_reads_percent":   list.Get("avg_physical_reads_percent").Value(),
					"total_duration_time":          list.Get("total_duration_time").Value(),
					"avg_logical_write":            list.Get("avg_logical_write").Value(),
					"total_logical_write_percent":  list.Get("total_logical_write_percent").Value(),
					"db_name":                      list.Get("db_name").Value(),
					"execution_count_percent":      list.Get("execution_count_percent").Value(),
					"total_cpu_time_percent":       list.Get("total_cpu_time_percent").Value(),
					"total_logical_reads":          list.Get("total_logical_reads").Value(),
				}
			},
		)),
	)
	return mErr.ErrorOrNil()
}
